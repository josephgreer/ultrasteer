#include <stdio.h>
#include "Common.h"
#include "JacobianControl.h"

struct JacobianTestData
{
  //Vec2f64 delta_x_desired;
  f64 q_res[5];
};

int main()
{
  JacobianTestData testData[] = {
    { -356.352529, -24.280793, 0.074072, 0.929907, 1.000000 },
    { 39.941583, -30.465344, 0.129953, 0.841962, 1.000000 },
    { 5.464396, 19.848427, 0.129953, 0.856949, 0.957690 },
    { -11.133521, 4.342671, 0.108388, 0.869485, 0.957690 },
    { -250.165437, 69.565317, 0.000000, 0.969438, 1.000000 },
    { -48.159266, 266.180382, 0.000000, 1.000000, 0.984022 },
    { -8.071445, -5.183887, 0.000000, 1.000000, 0.984022 },
    { -96.691088, -37.479680, 0.000000, 1.000000, 0.984022 },
    { -97.653469, 57.668323, 0.000000, 1.000000, 0.984022 },
    { -61.614649, -165.056207, 0.000000, 0.996570, 1.000000 },
    { 120.332318, 181.612064, 0.038696, 0.996570, 0.475731 },
    { 23.200744, -120.329147, 0.038696, 0.764888, 0.591409 },
    { 27.201998, 152.785872, 0.038696, 0.917411, 0.302877 },
    { 359.624095, -151.925116, 0.718472, 0.478841, 0.302877 },
    { -169.218421, -319.033908, 0.532063, 0.254992, 1.000000 },
    { 85.574700, -124.650271, 0.556170, 0.000000, 1.000000 },
    { 218.705058, 143.106348, 0.896377, 0.000000, 0.586888 },
    { -135.179675, -51.411166, 0.632633, 0.000000, 0.735299 },
    { 25.382487, 160.614695, 0.632633, 0.168371, 0.440015 },
    { -105.649956, 20.883827, 0.398651, 0.228658, 0.440015 },
    { -47.523285, 176.798845, 0.398651, 0.602653, 0.303636 },
    { 150.081967, -180.183789, 0.513783, 0.082507, 0.303636 },
    { -23.223499, 108.738715, 0.513783, 0.297517, 0.204744 },
    { -78.847048, 23.110356, 0.350023, 0.364231, 0.204744 },
    { 61.841870, 196.093626, 0.582920, 0.725560, 0.000000 },
    { 165.101401, 100.788502, 1.000000, 0.942944, 0.000000 },
    { -183.403986, 215.625218, 0.986500, 1.000000, 0.000000 },
    { -5.651111, -276.379401, 0.986500, 0.615208, 0.413047 },
    { -55.727336, -138.660710, 0.986500, 0.554387, 0.752505 },
    { -66.880874, -118.349005, 0.895971, 0.460238, 1.000000 },
    { -116.927462, -57.550130, 0.520585, 0.294105, 1.000000 },
    { -23.164143, 8.315765, 0.474678, 0.318111, 1.000000 },
    { 17.879601, 388.229545, 0.474678, 0.833773, 0.394940 },
    { 33.658547, 274.535400, 0.419904, 1.000000, 0.000000 },
    { -169.505615, -234.780551, 0.335017, 1.000000, 0.677753 },
    { -235.747892, 37.204263, 0.000000, 1.000000, 0.621802 },
    { 26.493019, 11.855891, 0.049120, 1.000000, 0.587577 },
    { 19.142351, 57.649392, 0.013766, 1.000000, 0.421157 },
    { 41.820435, 30.426235, 0.074401, 1.000000, 0.333324 },
    { -70.955780, -24.681625, 0.000000, 1.000000, 0.370718 },
    { 260.390234, -80.821191, 0.534320, 0.766689, 0.370718 },
    { -273.528967, -72.101378, 0.000000, 0.812122, 0.624289 },
    { -32.302640, 369.280135, 0.000000, 1.000000, 0.485851 },
    { 154.426868, -246.086864, 0.030871, 0.289608, 0.485851 },
    { -334.248451, 41.713511, 0.000000, 0.888395, 1.000000 },
    { -8.707361, -263.986799, 0.000000, 0.888395, 1.000000 },
    { 217.333779, -130.426823, 0.355080, 0.511885, 1.000000 },
    { -147.218828, 165.010776, 0.225205, 0.988230, 1.000000 },
    { 25.396850, 72.509880, 0.195808, 1.000000, 0.802452 },
    { -47.811286, -310.313038, 0.000000, 0.576557, 1.000000 },
    { 335.171199, -59.368711, 0.752237, 0.405174, 1.000000 },
    { -34.577396, -9.715333, 0.651770, 0.377128, 1.000000 },
    { -370.267830, 25.928223, 0.000000, 0.432050, 1.000000 },
    { 45.437311, -188.642721, 0.000000, 0.432050, 1.000000 },
    { -83.774713, 24.179426, 0.000000, 0.432050, 1.000000 },
    { 13.003580, 26.423059, 0.000000, 0.437679, 0.929353 },
    { 199.737823, -160.240376, 0.292952, 0.000000, 0.954247 },
    { 102.894435, 129.818766, 0.362811, 0.000000, 0.579493 },
    { 79.794003, 25.433620, 0.525586, 0.000000, 0.506072 },
    { -31.492937, -258.538068, 0.720444, 0.000000, 1.000000 },
    { -108.954832, 14.475386, 0.468951, 0.041787, 1.000000 },
    { -220.529589, -312.624386, 0.422529, 0.000000, 1.000000 },
    { -25.782075, 11.056923, 0.374033, 0.031919, 1.000000 },
    { 30.991405, 11.762217, 0.434535, 0.031919, 0.966045 },
    { 209.409414, -54.178063, 0.656054, 0.000000, 1.000000 },
    { 35.523224, -57.999358, 0.656054, 0.000000, 1.000000 },
    { -17.978752, 276.206489, 0.656054, 0.443617, 0.646277 },
    { 107.977300, -83.137751, 0.805999, 0.203619, 0.646277 },
    { 317.501132, 136.621667, 1.000000, 0.000000, 0.179786 },
    { -75.292681, 286.711551, 1.000000, 0.479797, 0.000000 },
    { 151.840402, 232.852659, 1.000000, 0.479797, 0.000000 },
    { 158.035323, -244.182023, 1.000000, 0.479797, 0.000000 },
    { -184.024957, 225.005099, 0.891644, 1.000000, 0.000000 },
    { 80.337720, 96.452271, 0.891644, 1.000000, 0.000000 },
    { -307.038493, 169.845569, 0.891644, 1.000000, 0.000000 },
    { 200.179969, 289.598211, 0.891644, 1.000000, 0.000000 },
    { 117.691535, -370.401548, 0.891644, 0.171143, 0.240400 },
    { -55.248096, 60.561517, 0.840936, 0.345969, 0.240400 },
    { 19.608350, 330.564069, 1.000000, 0.830060, 0.000000 },
    { 272.879285, -60.585161, 1.000000, 0.830060, 0.000000 },
    { -114.126269, 12.601805, 0.732873, 0.866438, 0.000000 },
    { 175.108530, -301.742502, 0.739734, 0.000000, 0.004617 },
    { 72.306447, 47.257228, 0.984093, 0.131803, 0.000000 },
    { 166.749585, -295.522751, 1.000000, 0.000000, 0.017602 },
    { -44.144856, 102.626055, 1.000000, 0.120475, 0.000000 },
    { -195.710234, 90.873036, 0.641888, 0.382803, 0.000000 },
    { 276.205620, 189.150638, 1.000000, 0.585744, 0.000000 },
    { -302.633860, -67.117545, 0.340291, 0.585744, 0.193752 },
    { 46.379854, 383.321679, 0.514253, 1.000000, 0.000000 },
    { 0.885830, -137.234687, 0.514253, 0.799704, 0.195867 },
    { 265.678093, -89.049599, 1.000000, 0.492724, 0.145950 },
    { 9.805580, -15.331385, 1.000000, 0.446081, 0.143565 },
    { 279.122956, 101.763258, 1.000000, 0.352445, 0.000000 },
    { -69.638459, 194.630568, 1.000000, 0.352445, 0.000000 },
    { 217.303109, 325.272048, 1.000000, 0.352445, 0.000000 },
    { -331.550894, -5.731542, 0.179396, 0.352445, 0.016546 },
    { 171.209385, 85.935722, 0.714911, 0.583974, 0.000000 },
    { 326.960252, 134.900923, 1.000000, 0.693666, 0.000000 },
    { -25.845867, 9.156733, 0.948602, 0.720100, 0.000000 },
    { 191.098776, 99.643676, 1.000000, 0.743885, 0.000000 },
  };

  JacobianControl jc;

  f64 initQ[N_TURN_ACT] = { 1,1,1 };
  jc.SetQs(&initQ[0]);

  Vec2f64 J[N_TURN_ACT];

  const f64 *qs;
 
  J[0] = Vec2f64(400, 0); J[1] = Vec2f64(-200.0000, 346.4102); J[2] = Vec2f64(-200.0000, -346.4102);
  for (s32 i = 0; i < sizeof(testData) / sizeof(testData[0]); i++) {
    Vec2f64 dx(testData[i].q_res[0], testData[i].q_res[1]);

    qs = jc.Update(dx, J);

    f64 maxError = -1;
    for (s32 j = 0; j < N_TURN_ACT; j++) 
      maxError = MAX(maxError, ABS(qs[j] - testData[i].q_res[2 + j]));

    if (maxError > 1e-4)
      s32 y = 0;

    jc.SetQs(&testData[i].q_res[2]);

  }
}